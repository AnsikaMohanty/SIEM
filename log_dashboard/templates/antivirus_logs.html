<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Antivirus Logs - SIEM Dashboard</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
body { background-color: #f4f6f8; }
h2 { color: #343a40; }
.table-container { background: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);}
.table thead { background-color: #f1f3f5; position: sticky; top:0; z-index:2;}
.table-hover tbody tr:hover { background-color:#f8f9fa;}
.badge-critical { background-color: #8B0000; color:white; }
.badge-high { background-color: #FF0000; color:white; }
.badge-medium { background-color: #FFD700; color:black; }
.badge-low { background-color: #28a745; color:white; }
.chart-container { background: #ffffff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow:0 4px 12px rgba(0,0,0,0.05);}
.filter-section { background:#fff; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 6px rgba(0,0,0,0.05);}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow">
<div class="container">
<a class="navbar-brand" href="/">SIEM Dashboard</a>
<div class="collapse navbar-collapse justify-content-end">
<ul class="navbar-nav">
<li class="nav-item"><a href="/logs/login_log_data" class="nav-link">Login Logs</a></li>
<li class="nav-item"><a href="/logs/server_access_logs" class="nav-link">Server Access</a></li>
<li class="nav-item"><a href="/logs/rdp_events" class="nav-link">RDP Events</a></li>
</ul>
</div>
</div>
</nav>

<!-- üîπ New Section: View ML Insights Button -->
<div class="container mt-3">
  <div class="d-flex justify-content-end">
    <a href="{{ url_for('ml_insights.antivirus') }}" class="btn btn-outline-primary">
      <i class="bi bi-bar-chart"></i> View ML Insights
    </a>
  </div>
</div>

<div class="container my-5">
<h2 class="mb-4 text-center">üõ°Ô∏è Antivirus Logs Summary</h2>

<div class="row">
<div class="col-md-6 chart-container">
<h5 class="text-center">Severity Distribution</h5>
<canvas id="severityChart"></canvas>
</div>
<div class="col-md-6 chart-container">
<h5 class="text-center">Malware Types</h5>
<canvas id="malwareChart"></canvas>
</div>
</div>

<div class="filter-section mt-4">
<div class="row align-items-center">
<div class="col-md-3">
<select class="form-select" id="severityFilter">
<option value="">All Severity</option>
<option value="Critical">Critical</option>
<option value="High">High</option>
<option value="Medium">Medium</option>
<option value="Low">Low</option>
</select>
</div>
<div class="col-md-6">
<input type="text" id="searchInput" class="form-control" placeholder="Search by File Path or Malware Type">
</div>
<div class="col-md-3 text-end">
<button class="btn btn-success w-100" id="downloadCsv"><i class="bi bi-download"></i> Export CSV</button>
</div>
</div>
</div>

<div class="table-container mt-4">
<h5>Antivirus Logs</h5>
<table class="table table-hover table-bordered" id="antivirusTable">
<thead>
<tr>
<th>ID</th>
<th>Timestamp</th>
<th>File Path</th>
<th>Malware Type</th>
<th>Severity</th>
<th>Scan Type</th>
</tr>
</thead>
<tbody>
{% for log in logs %}
<tr class="severity-{{ log.severity|lower }}">
<td>{{ log.id }}</td>
<td>{{ log.timestamp }}</td>
<td>{{ log.file_path[:50] }}{% if log.file_path|length>50 %}...{% endif %}</td>
<td>{{ log.malware_type }}</td>
<td><span class="badge badge-{{ log.severity|lower }}">{{ log.severity }}</span></td>
<td>{{ log.scan_type }}</td>
</tr>
{% endfor %}
</tbody>
</table>
<div class="text-center mt-3">
<button class="btn btn-primary" id="showMoreBtn">Show More</button>
<button class="btn btn-secondary d-none" id="showLessBtn">Show Less</button>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ==== Charts ====
const severityData = {{ severity_summary|tojson | default('{"labels":[],"data":[]}') }};
const malwareData = {{ malware_summary|tojson | default('{"labels":[],"data":[]}') }};

// ==== Severity Chart Colors ====
const severityColorsMap = {
    "Critical": "#8B0000",
    "High": "#FF0000",
    "Medium": "#FFD700",
    "Low": "#28a745"
};
const severityColors = severityData.labels.map(label => severityColorsMap[label] || "#6c757d");

new Chart(document.getElementById('severityChart'), {
    type: 'pie',
    data: {
        labels: severityData.labels,
        datasets: [{ data: severityData.data, backgroundColor: severityColors }]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
});

new Chart(document.getElementById('malwareChart'), {
    type: 'bar',
    data: { labels: malwareData.labels, datasets: [{ label: "Count", data: malwareData.data, backgroundColor: "rgba(54,162,235,0.6)" }] },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
});

// ==== Filter & Search ====
let offset = {{ logs|length }};
const tableBody = document.querySelector("#antivirusTable tbody");
const showMoreBtn = document.getElementById("showMoreBtn");
const showLessBtn = document.getElementById("showLessBtn");
const searchInput = document.getElementById("searchInput");
const severityFilter = document.getElementById("severityFilter");

function filterRow(row){
    const severityVal = severityFilter.value.toLowerCase();
    const searchVal = searchInput.value.toLowerCase();
    const rowSeverity = row.querySelector("td:nth-child(5)").innerText.toLowerCase();
    const filePath = row.querySelector("td:nth-child(3)").innerText.toLowerCase();
    const malware = row.querySelector("td:nth-child(4)").innerText.toLowerCase();
    return ((severityVal && rowSeverity !== severityVal) ? false : true)
           && ((filePath.includes(searchVal) || malware.includes(searchVal)) ? true : searchVal=="");
}

function applyFilters(){
    tableBody.querySelectorAll("tr").forEach(row=>{
        row.style.display = filterRow(row) ? "" : "none";
    });
}

searchInput.addEventListener("keyup", applyFilters);
severityFilter.addEventListener("change", applyFilters);

// ==== Show More / Less ====
showMoreBtn.addEventListener("click", ()=>{
    fetch(`/logs/antivirus_logs/more?offset=${offset}&search=${searchInput.value}&severity=${severityFilter.value}`)
    .then(res=>res.json())
    .then(data=>{
        data.forEach(log=>{
            const tr = document.createElement("tr");
            tr.className = `severity-${log.severity.toLowerCase()}`;
            tr.innerHTML = `
                <td>${log.id}</td>
                <td>${log.timestamp}</td>
                <td>${log.file_path.substring(0,50)}${log.file_path.length>50?'...':''}</td>
                <td>${log.malware_type}</td>
                <td><span class="badge badge-${log.severity.toLowerCase()}">${log.severity}</span></td>
                <td>${log.scan_type}</td>
            `;
            tableBody.appendChild(tr);
        });
        offset += data.length;
        applyFilters();
        showLessBtn.classList.remove("d-none");
    });
});

showLessBtn.addEventListener("click", ()=>{
    while(tableBody.rows.length > 50){
        tableBody.deleteRow(50);
    }
    offset = tableBody.rows.length;
    showLessBtn.classList.add("d-none");
});

// ==== Export CSV ====
document.getElementById("downloadCsv").addEventListener("click",()=>{
    let csv = [];
    tableBody.querySelectorAll("tr").forEach(row=>{
        const cols = row.querySelectorAll("td");
        csv.push(Array.from(cols).map(c=>`"${c.innerText}"`).join(","));
    });
    const blob = new Blob([csv.join("\n")], {type:"text/csv"});
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url; a.download="antivirus_logs.csv"; a.click();
    window.URL.revokeObjectURL(url);
});
</script>
</body>
</html>
