<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login Logs - SIEM Dashboard</title>
<link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
body { background-color: #f4f6f8; }
h2 { color: #343a40; }
.table-container { background: #ffffff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);}
.table thead { background-color: #f1f3f5; position: sticky; top:0; z-index:2;}
.table-hover tbody tr:hover { background-color:#f8f9fa;}
.badge-successful { background-color: rgba(40,167,69,0.8); color:white;}
.badge-failed { background-color: rgba(220,53,69,0.8); color:white;}
.chart-container { background: #ffffff; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow:0 4px 12px rgba(0,0,0,0.05);}
.filter-section { background:#fff; padding:15px; border-radius:8px; margin-bottom:20px; box-shadow:0 2px 6px rgba(0,0,0,0.05);}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow">
<div class="container">
<a class="navbar-brand" href="/">SIEM Dashboard</a>
<div class="collapse navbar-collapse justify-content-end">
<ul class="navbar-nav">
<li class="nav-item"><a href="/logs/antivirus_logs" class="nav-link">Antivirus Logs</a></li>
<li class="nav-item"><a href="/logs/server_access_logs" class="nav-link">Server Access</a></li>
<li class="nav-item"><a href="/logs/rdp_events" class="nav-link">RDP Events</a></li>
</ul>
</div>
</div>
</nav>

<div class="container my-5">
<h2 class="mb-4 text-center">üîê Login Log Summary</h2>

<div class="row">
<div class="col-md-6 chart-container">
<h5 class="text-center">Login Success vs Failed</h5>
<canvas id="statusChart"></canvas>
</div>
<div class="col-md-6 chart-container">
<h5 class="text-center">Login Attempts by ASN</h5>
<canvas id="asnChart"></canvas>
</div>
</div>

<div class="filter-section mt-4">
<div class="row align-items-center">
<div class="col-md-4">
<select class="form-select" id="statusFilter">
<option value="">All Status</option>
<option value="Successful">Successful</option>
<option value="Failed">Failed</option>
</select>
</div>
<div class="col-md-6">
<input type="text" id="searchInput" class="form-control" placeholder="Search by IP or ASN...">
</div>
<div class="col-md-2 text-end">
<button class="btn btn-success w-100" id="downloadCsv"><i class="bi bi-download"></i> Export CSV</button>
</div>
</div>
</div>

<div class="table-container mt-4">
<h5>Login Attempts</h5>
<table class="table table-hover table-bordered" id="loginTable">
<thead>
<tr>
<th>ID</th>
<th>Timestamp</th>
<th>IP Address</th>
<th>ASN</th>
<th>Status</th>
</tr>
</thead>
<tbody>
{% for log in logs %}
<tr>
<td>{{ log.id }}</td>
<td>{{ log.login_timestamp }}</td>
<td>{{ log.ip_address }}</td>
<td>{{ log.asn }}</td>
<td>
{% if log.login_successful == 1 %}
<span class="badge badge-successful">Successful</span>
{% else %}
<span class="badge badge-failed">Failed</span>
{% endif %}
</td>
</tr>
{% endfor %}
</tbody>
</table>
<div class="text-center mt-3">
<button class="btn btn-primary" id="showMoreBtn">Show More</button>
<button class="btn btn-secondary d-none" id="showLessBtn">Show Less</button>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ==== Status Pie Chart with Correct Colors ====
const statusData = {{ summary|tojson | default('{"labels":[],"data":[]}') }};

// Map labels to correct counts
let successfulCount = 0, failedCount = 0;
statusData.labels.forEach((label, i) => {
    if (label === "Successful") successfulCount = statusData.data[i];
    else if (label === "Failed") failedCount = statusData.data[i];
});

new Chart(document.getElementById('statusChart'), {
    type: 'pie',
    data: {
        labels: ["Successful", "Failed"],
        datasets: [{
            data: [successfulCount, failedCount],
            backgroundColor: ["rgba(40,167,69,0.8)", "rgba(220,53,69,0.8)"]
        }]
    },
    options: {
        responsive: true,
        plugins: { legend: { position: 'bottom' } }
    }
});

// ==== ASN Bar Chart ====
const asnData = {{ asn_summary|tojson | default('{"labels":[],"data":[]}') }};
new Chart(document.getElementById('asnChart'), {
    type: 'bar',
    data: {
        labels: asnData.labels,
        datasets: [{
            label: "Attempts",
            data: asnData.data,
            backgroundColor: "rgba(54,162,235,0.6)"
        }]
    },
    options: {
        responsive: true,
        scales: { y: { beginAtZero: true } }
    }
});

// ==== Filters & Show More / Less ====
let offset = {{ logs|length }};
const showMoreBtn = document.getElementById("showMoreBtn");
const showLessBtn = document.getElementById("showLessBtn");
const tableBody = document.querySelector("#loginTable tbody");
const searchInput = document.getElementById("searchInput");
const statusFilter = document.getElementById("statusFilter");

function filterRow(row){
    const statusVal = statusFilter.value.toLowerCase();
    const searchVal = searchInput.value.toLowerCase();
    const statusText = row.cells[4].innerText.toLowerCase();
    const ip = row.cells[2].innerText.toLowerCase();
    const asn = row.cells[3].innerText.toLowerCase();
    return ((statusVal && statusText !== statusVal) ? false : true) && ((ip.includes(searchVal) || asn.includes(searchVal)) ? true : searchVal=="" );
}

function applyFilters(){
    document.querySelectorAll("#loginTable tbody tr").forEach(row=>{
        row.style.display = filterRow(row) ? "" : "none";
    });
}

statusFilter.addEventListener("change",applyFilters);
searchInput.addEventListener("keyup",applyFilters);

// Show More / Show Less
showMoreBtn.addEventListener("click", ()=>{
    fetch(`/logs/login_log_data/more?offset=${offset}&search=${searchInput.value}`)
    .then(res=>res.json())
    .then(data=>{
        data.forEach(log=>{
            const tr=document.createElement("tr");
            tr.innerHTML=`
                <td>${log.id}</td>
                <td>${log.login_timestamp}</td>
                <td>${log.ip_address}</td>
                <td>${log.asn}</td>
                <td>${log.login_successful==1 ? '<span class="badge badge-successful">Successful</span>' : '<span class="badge badge-failed">Failed</span>'}</td>
            `;
            tableBody.appendChild(tr);
        });
        offset += data.length;
        applyFilters();
        showLessBtn.classList.remove("d-none");
    });
});

showLessBtn.addEventListener("click",()=>{
    while(tableBody.rows.length>50){
        tableBody.deleteRow(50);
    }
    offset = tableBody.rows.length;
    showLessBtn.classList.add("d-none");
});

// Export CSV
document.getElementById("downloadCsv").addEventListener("click",()=>{
    let csv=[];
    document.querySelectorAll("#loginTable tr").forEach(row=>{
        const cols=row.querySelectorAll("td, th");
        csv.push(Array.from(cols).map(c=>`"${c.innerText}"`).join(","));
    });
    const blob=new Blob([csv.join("\n")],{type:"text/csv"});
    const url=window.URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;a.download="login_log_data.csv";a.click();window.URL.revokeObjectURL(url);
});
</script>
</body>
</html>
